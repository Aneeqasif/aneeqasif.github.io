/**
 * CUSTOM STYLES: Enhanced Figure Directive
 * Safe for upstream merges - doesn't modify theme core
 *
 * Usage in Markdown:
 * :::figure{width="80%" height="300px" float="right" grid=3 .blur .hue .shadow}
 * ![Caption](/path/to/image.jpg)
 * :::
 */

.custom-md {
  /* ========================================
     Enhanced Figure Directive Styles
     :::figure{width height float grid .blur .hue .shadow}
     ======================================== */

  .enhanced-figure {
    margin: 1.5rem auto;
    width: var(--figure-width, auto);
    max-width: 100%;
    padding: 0;
    border: 0;
  }

  .enhanced-figure__img-wrapper {
    border-radius: 0.5rem;
    margin: 0;
    padding: 0;
    line-height: 0; /* Remove inline-block gap below image */
  }

  /* Only use overflow:hidden when needed (blur effect) */
  .enhanced-figure:not(.shadow-effect) .enhanced-figure__img-wrapper {
    overflow: hidden;
  }

  .enhanced-figure__img {
    display: block;
    width: 100%;
    height: var(--figure-height, auto);
    max-width: 100%;
    object-fit: contain;
    margin: 0;
    padding: 0;
  }

  /* When height is set, constrain by height and auto-width */
  .enhanced-figure[style*="--figure-height"] {
    width: auto;

    .enhanced-figure__img {
      width: auto;
      max-height: var(--figure-height);
    }
  }

  .enhanced-figure__caption {
    @apply text-center text-sm text-black/60 dark:text-white/60;
    margin-top: 1.5rem;
    line-height: 1.4;
  }

  /* Grid individual captions */
  .enhanced-figure__grid-caption {
    @apply text-center text-xs text-black/50 dark:text-white/50;
    margin-top: 1.5rem;
    padding: 0 0.25rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* ---- Float variants ---- */
  .enhanced-figure.float-left {
    float: left;
    margin: 0 0.75rem 0.25rem 0;
    padding: 0;
    width: var(--figure-width, 40%);
    max-width: 50%;
  }

  .enhanced-figure.float-right {
    float: right;
    margin: 0 0 0.25rem 0.75rem;
    padding: 0;
    width: var(--figure-width, 40%);
    max-width: 50%;
  }

  /* Responsive: collapse floats on mobile */
  @media (max-width: 640px) {
    .enhanced-figure.float-left,
    .enhanced-figure.float-right {
      float: none;
      margin: 1.5rem auto;
      width: 100%;
      max-width: 100%;
    }
  }

  /* ---- Blur effect (reveal on hover) ---- */
  .enhanced-figure.blur-effect {
    .enhanced-figure__img-wrapper {
      position: relative;
      overflow: hidden;
      border-radius: 0.5rem;
    }

    .enhanced-figure__img {
      @apply transition-all duration-300 ease-out;
      filter: blur(12px);
      /* Prevent blur bleeding outside rounded corners */
      transform: scale(1.1);
    }

    &:hover .enhanced-figure__img {
      filter: blur(0);
      transform: scale(1);
    }

    /* Hint overlay - contained within rounded boundary */
    .enhanced-figure__img-wrapper::after {
      content: "Hover to reveal";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      pointer-events: none;
      @apply text-black/50 dark:text-white/50 bg-black/5 dark:bg-white/5 transition-opacity duration-300;
    }

    &:hover .enhanced-figure__img-wrapper::after {
      opacity: 0;
    }
  }

  /* ---- Hue effect (Dark Reader style for charts/diagrams) ---- */
  /* Light mode: no processing, images display normally */
  .enhanced-figure.hue-effect {
    .enhanced-figure__img-wrapper {
      position: relative;
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .enhanced-figure__img {
      @apply transition-all duration-300;
    }
  }
}

/* Dark mode: invert light images, blend dark areas with card-bg */
/* Must be outside .custom-md to properly target .dark on html */
.dark .custom-md .enhanced-figure.hue-effect {
  .enhanced-figure__img-wrapper {
    /* Card background as base */
    background-color: var(--card-bg);
  }

  /* Overlay to tint the inverted dark areas with card-bg color */
  .enhanced-figure__img-wrapper::after {
    content: "";
    position: absolute;
    inset: 0;
    background-color: var(--card-bg);
    mix-blend-mode: lighten;
    opacity: 0.92;
    pointer-events: none;
    @apply transition-opacity duration-300;
  }

  .enhanced-figure__img {
    /* Invert: white bg → black, black text → white */
    /* hue-rotate(180deg) corrects color shift from invert */
    filter: invert(1) hue-rotate(180deg) contrast(0.9);
  }

  /* Hover shows original true colors */
  &:hover .enhanced-figure__img-wrapper::after {
    opacity: 0;
  }

  &:hover .enhanced-figure__img {
    filter: none;
  }
}

.custom-md {
  /* ---- Grid layout for multiple images ---- */
  .enhanced-figure.grid-layout {
    width: var(--figure-width, 100%);
  }

  .enhanced-figure__grid {
    display: grid;
    grid-template-columns: repeat(var(--figure-grid-cols, 2), 1fr);
    gap: 0.75rem;
  }

  .enhanced-figure.soft-edges .enhanced-figure__img-wrapper {
    mask-image: linear-gradient(
        to bottom,
        transparent,
        black 10%,
        black 90%,
        transparent
      ),
      linear-gradient(to right, transparent, black 10%, black 90%, transparent);

    /* Standard property */
    mask-composite: intersect;

    /* WebKit prefix */
    -webkit-mask-image: linear-gradient(
        to bottom,
        transparent,
        black 10%,
        black 90%,
        transparent
      ),
      linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    -webkit-mask-composite: source-in;
  }

  /* Add padding when grid has shadow to prevent clipping */
  .enhanced-figure.shadow-effect .enhanced-figure__grid {
    padding: 0.5rem;
    gap: 1.25rem;
  }

  /* Responsive grid: reduce columns on smaller screens */
  @media (max-width: 640px) {
    .enhanced-figure__grid {
      grid-template-columns: repeat(min(var(--figure-grid-cols, 2), 2), 1fr);
    }
  }

  @media (max-width: 400px) {
    .enhanced-figure__grid {
      grid-template-columns: 1fr;
    }
  }

  .enhanced-figure.grid-layout .enhanced-figure__img-wrapper {
    display: flex;
    flex-direction: column;
  }

  .enhanced-figure.grid-layout .enhanced-figure__img {
    width: 100%;
    height: auto;
    object-fit: cover;
    border-radius: 0.5rem;
    aspect-ratio: 1 / 1;
  }

  /* ---- Shadow effect ---- */
  /* For non-grid figures, shadow on wrapper is fine */
  .enhanced-figure.shadow-effect:not(.grid-layout) {
    .enhanced-figure__img-wrapper {
      overflow: visible;
      box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.25),
        0 4px 8px -2px rgba(0, 0, 0, 0.15);
      border-radius: 0.5rem;
    }

    .enhanced-figure__img {
      border-radius: 0.5rem;
    }
  }
}

.dark .custom-md .enhanced-figure.shadow-effect:not(.grid-layout) {
  .enhanced-figure__img-wrapper {
    box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.5),
      0 4px 8px -2px rgba(0, 0, 0, 0.3);
  }
}

.custom-md {
  /* For grid figures, shadow directly on img to exclude caption */
  .enhanced-figure.shadow-effect.grid-layout {
    .enhanced-figure__img-wrapper {
      overflow: visible;
    }

    .enhanced-figure__img {
      box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.25),
        0 4px 8px -2px rgba(0, 0, 0, 0.15);
      border-radius: 0.5rem;
    }
  }
}

.dark .custom-md .enhanced-figure.shadow-effect.grid-layout {
  .enhanced-figure__img {
    box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.5),
      0 4px 8px -2px rgba(0, 0, 0, 0.3);
  }
}

.custom-md {
  /* ---- Clear float utility ---- */
  .clear-float,
  .clear {
    clear: both;
  }
}
