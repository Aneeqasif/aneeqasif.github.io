# PondPilot Widget Theming System

This document describes the custom theming system implemented for PondPilot widgets to match Expressive Code blocks in the blog.

## Overview

The PondPilot widgets are styled to seamlessly match the blog's Expressive Code syntax highlighting theme. The system automatically extracts colors from Shiki themes and applies them to PondPilot widgets, ensuring visual consistency across all code displays.

## Architecture

### Single Source of Truth

The theme is defined in **one place only**:

```typescript
// src/config.ts
export const expressiveCodeConfig: ExpressiveCodeConfig = {
  theme: "github-dark",  // Change this to switch themes globally
};
```

When you change this value, **both** Expressive Code blocks and PondPilot widgets update automatically.

### Build-Time Color Extraction

The system uses a Vite plugin to extract syntax colors at build time:

```
src/config.ts (theme name)
       ↓
src/plugins/vite-plugin-theme-colors.ts (Shiki tokenization)
       ↓
src/generated/theme-colors.ts (auto-generated color constants)
       ↓
src/scripts/pondpilot-init.ts (injects into PondPilot config)
       ↓
PondPilot widgets (styled with extracted colors)
```

## Files Created/Modified

### 1. Vite Plugin for Color Extraction
**File**: `src/plugins/vite-plugin-theme-colors.ts`

**Purpose**: Extracts syntax highlighting colors from Shiki themes at build time.

**Key Features**:
- Runs automatically when dev server starts or during build
- Only regenerates when `src/config.ts` changes (efficient)
- Uses realistic SQL samples to extract accurate token colors
- Generates TypeScript file with type-safe color exports

**How it works**:
1. Reads theme name from `src/config.ts` using regex
2. Creates Shiki highlighter for that theme
3. Tokenizes SQL code samples (SELECT, identifiers, strings, etc.)
4. Extracts colors from each token type
5. Generates `src/generated/theme-colors.ts` with color constants

**SQL Samples Used**:
```typescript
const samples = {
  keywords: "SELECT FROM WHERE JOIN ORDER BY",        // → syntaxKeyword
  realSQL: "SELECT o.order_id FROM orders o",        // → syntaxIdentifier (uses dotted syntax!)
  numbers: "SELECT 123, 45.67 FROM table",           // → syntaxNumber
  strings: "SELECT 'hello', \"world\" FROM table",   // → syntaxString
  comments: "-- This is a comment\nSELECT * FROM",   // → syntaxComment
  functions: "SELECT COUNT(*), SUM(amount) FROM",    // → syntaxSpecial
};
```

**Critical Note**: The identifier extraction uses **dotted syntax** (`o.order_id`) because simple word lists tokenize as plain text, not identifiers.

### 2. Auto-Generated Color Constants
**File**: `src/generated/theme-colors.ts` (AUTO-GENERATED)

**DO NOT EDIT THIS FILE MANUALLY** - It's regenerated automatically.

**Example Output**:
```typescript
// AUTO-GENERATED - DO NOT EDIT
// Generated by vite-plugin-theme-colors.ts
// Theme: github-dark

export const themeColors = {
  "syntaxKeyword": "#F97583",      // SELECT, FROM, WHERE
  "syntaxIdentifier": "#79B8FF",   // column/table names
  "syntaxNumber": "#79B8FF",       // numeric literals
  "syntaxString": "#9ECBFF",       // string literals
  "syntaxComment": "#6A737D",      // SQL comments
  "syntaxSpecial": "#79B8FF"       // functions (COUNT, SUM)
} as const;

export type ThemeColors = typeof themeColors;
```

### 3. PondPilot Initialization Script
**File**: `src/scripts/pondpilot-init.ts`

**Modified**: Added import and usage of theme colors

**Changes**:
```typescript
// Line 10: Import generated colors
import { themeColors } from "../generated/theme-colors";

// Line 147: Debug logging
console.log("[PondPilot] Using theme colors:", themeColors);

// Line 172: Spread into PondPilot config
window.PondPilot.config({
  customThemes: {
    "site-theme": {
      extends: "dark",
      config: {
        bgColor: codeblockBg,
        editorBg: codeblockBg,
        ...themeColors,  // ← Injects all syntax colors
        editorFontFamily: "Iosevka, ...",
      }
    }
  }
});
```

### 4. Custom CSS Styling
**File**: `src/styles/custom/pondpilot.css`

**Purpose**: Override PondPilot's default styles to match Expressive Code exactly.

**Structure** (7 sections):

#### Section 1: Derived Colors
Computed colors based on `--codeblock-bg` using CSS `oklch()` color manipulation:

```css
:root, :root.dark {
  /* Output background: slightly lighter than editor (+0.02 lightness) */
  --pondpilot-output-bg-derived: oklch(from var(--codeblock-bg) calc(l + 0.02) c h);
  
  /* Table header: darker for visual hierarchy (-0.04 lightness) */
  --pondpilot-table-header-bg-derived: oklch(from var(--pondpilot-output-bg-derived) calc(l - 0.04) c h);
  
  /* Alternating rows: subtle darker shade (-0.025 lightness) */
  --pondpilot-table-row-alt: oklch(from var(--pondpilot-output-bg-derived) calc(l - 0.025) c h);
  
  /* Hover state: lighter for feedback (+0.05 lightness) */
  --pondpilot-table-row-hover: oklch(from var(--pondpilot-output-bg-derived) calc(l + 0.05) c h);
  
  /* Border color: with transparency */
  --pondpilot-table-border: oklch(from var(--pondpilot-output-bg-derived) calc(l + 0.08) c h / 0.4);
}
```

**Why This Works**: CSS relative color syntax (`oklch(from ...)`) automatically adapts to any theme change.

#### Section 2: CSS Custom Properties
Maps site theme variables to PondPilot variables:

```css
:root, :root.dark {
  /* Backgrounds */
  --pondpilot-bg-color: var(--codeblock-bg) !important;
  --pondpilot-editor-bg: var(--codeblock-bg) !important;
  --pondpilot-output-bg: var(--pondpilot-output-bg-derived) !important;
  
  /* Buttons */
  --pondpilot-primary-bg: var(--primary) !important;
  --pondpilot-primary-hover: oklch(0.80 0.14 var(--hue)) !important;
  
  /* Typography */
  --pondpilot-editor-font-family: 'Iosevka', ui-monospace, ... !important;
  --pondpilot-font-size: 1.0rem !important;
  
  /* Syntax colors injected by JavaScript at runtime */
}
```

#### Section 3: Widget Container
Button layout and spacing:

```css
.pondpilot-button-container {
  display: flex !important;
  gap: 8px !important;          /* Space between Run and Reset */
  padding: 5px 5px !important;  /* Visual alignment for single-line SQL */
}

.pondpilot-run-button {
  background: var(--pondpilot-primary-bg) !important;
  border-radius: 0.55rem !important;
}
```

#### Section 4: Editor Section
SQL input area styling:

```css
.pondpilot-editor pre {
  background: var(--pondpilot-editor-bg) !important;
  font-family: var(--pondpilot-editor-font-family) !important;
  font-size: var(--pondpilot-editor-font-size) !important;
  line-height: 1.7rem !important;
  border-radius: 0.75rem !important;
}

.pondpilot-editor pre:focus {
  outline: 2px solid var(--pondpilot-primary-bg) !important;
  outline-offset: -2px !important;  /* Matches widget border-radius */
}
```

#### Section 5: Output Section
Query results layout:

```css
.pondpilot-output-content {
  padding: 0 !important;
  display: flex !important;
  flex-direction: column !important;
}

/* Move "Returned X rows in Y ms" to bottom */
.pondpilot-output-content > div:first-child {
  order: 2 !important;
  margin-top: 8px !important;
  padding: 0 12px !important;
}

/* Table comes first */
.pondpilot-output-content > table {
  order: 1 !important;
}
```

**Why**: This reorders the DOM visually so the table appears before the timing metadata.

#### Section 6: Table Styling
Results table with proper hierarchy:

```css
/* Remove table borders/radius for seamless integration */
.pondpilot-output table {
  background: var(--pondpilot-output-bg) !important;
  border: none !important;
  border-radius: 0 !important;
  margin: 0 !important;
}

/* Bold, uppercase headers with strong bottom border */
.pondpilot-output th {
  background: var(--pondpilot-table-header-bg) !important;
  font-size: 0.95rem !important;
  font-weight: 600 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.05em !important;
  border-bottom: 2px solid var(--pondpilot-border-color) !important;
}

/* Smaller font for data cells */
.pondpilot-output td {
  font-size: 0.925rem !important;
  border-bottom: none !important;
}

/* Alternating rows on ODD rows (1, 3, 5) */
.pondpilot-output tbody tr:nth-child(odd) {
  background: var(--pondpilot-table-row-alt) !important;
}

/* Hover feedback */
.pondpilot-output tbody tr:hover {
  background: var(--pondpilot-table-row-hover) !important;
}
```

**Visual Hierarchy**:
1. Header row: Darkest, bold, uppercase
2. Odd rows (1,3,5): Slightly darker (alternating)
3. Even rows (2,4): Base output background (lighter)
4. Hover: Lightest (clear feedback)

#### Section 7: Error Styling
Error message display:

```css
.pondpilot-output-content .pondpilot-error {
  margin: 140px 8px !important;         /* Space from edges */
  background: var(--pondpilot-error-bg) !important;
  border: 1px solid var(--pondpilot-error-border) !important;
  border-radius: 11px !important;
  font-size: 0.9rem;
  line-height: 1.5 !important;
  white-space: pre-wrap !important;    /* Preserve error formatting */
  word-break: break-word !important;   /* Wrap long lines */
}
```

### 5. Astro Configuration
**File**: `astro.config.mjs`

**Modified**: Added Vite plugin import and configuration

**Changes**:
```javascript
// Import the plugin
import { themeColorsPlugin } from "./src/plugins/vite-plugin-theme-colors.ts";

// Add to Vite plugins array
export default defineConfig({
  // ... other config
  vite: {
    plugins: [themeColorsPlugin()],  // ← Runs color extraction
    // ... other plugins
  },
});
```

### 6. Package Scripts
**File**: `package.json`

**Note**: Originally added `generate-theme` script, but **removed** after switching to Vite plugin approach (automatic generation).

**No manual script needed** - colors generate automatically!

## How to Change Themes

### Step 1: Update Theme Name
Edit `src/config.ts`:

```typescript
export const expressiveCodeConfig: ExpressiveCodeConfig = {
  theme: "dracula",  // Try: dracula, nord, monokai, catppuccin-mocha, etc.
};
```

### Step 2: Restart Dev Server
The Vite plugin will automatically:
1. Detect the theme change
2. Extract new colors from Shiki
3. Regenerate `src/generated/theme-colors.ts`
4. Trigger Hot Module Replacement (HMR)

**Both Expressive Code and PondPilot will update together!**

## Available Themes

Run this command to see all bundled Shiki themes:
```bash
node -e "import('shiki').then(s => console.log(Object.keys(s.bundledThemes).join('\n')))"
```

Popular choices:
- **Dark**: `github-dark`, `dracula`, `nord`, `monokai`, `catppuccin-mocha`, `tokyo-night`
- **Light**: `github-light`, `github-light-default`, `catppuccin-latte`

## Color Derivation Math

The system uses OKLCH color space for perceptually uniform color adjustments:

| Variable                              | Formula           | Purpose                         |
| ------------------------------------- | ----------------- | ------------------------------- |
| `--pondpilot-output-bg-derived`       | `l + 0.02`        | Slightly lighter than editor    |
| `--pondpilot-table-header-bg-derived` | `l - 0.04`        | Noticeably darker for hierarchy |
| `--pondpilot-table-row-alt`           | `l - 0.025`       | Subtle alternating shade        |
| `--pondpilot-table-row-hover`         | `l + 0.05`        | Clear hover feedback            |
| `--pondpilot-table-border`            | `l + 0.08, α=0.4` | Visible but subtle borders      |

Where `l` = lightness from `--pondpilot-output-bg-derived`

## Troubleshooting

### Colors not updating after theme change?

**Solution**: Fully restart the dev server:
```bash
# Stop current server (Ctrl+C)
pnpm dev
```

The Vite plugin runs on server start and watches for config changes.

### Identifier colors look wrong?

The plugin uses **realistic SQL with dotted syntax** (`o.order_id`) for proper tokenization. Simple word lists tokenize as plain text, not identifiers. This is intentional and correct.

### Want to tweak specific colors?

**Don't edit** `src/generated/theme-colors.ts` (auto-generated).

Instead, modify the Vite plugin's extraction logic in `src/plugins/vite-plugin-theme-colors.ts`.

### Table hierarchy not clear enough?

Adjust the lightness offsets in `src/styles/custom/pondpilot.css` Section 1:

```css
/* Make header darker */
--pondpilot-table-header-bg-derived: oklch(from ... calc(l - 0.06) c h);

/* Make alternating rows more pronounced */
--pondpilot-table-row-alt: oklch(from ... calc(l - 0.04) c h);
```

## Design Principles

1. **Single Source of Truth**: Theme defined once in `src/config.ts`
2. **Build-Time Generation**: Colors extracted during build, not runtime
3. **Type Safety**: Auto-generated TypeScript with const assertions
4. **Automatic Updates**: Vite plugin watches for changes
5. **Visual Hierarchy**: Clear distinction between header, data, and interactive states
6. **Responsive Design**: Works across all screen sizes
7. **Accessibility**: Proper contrast ratios maintained

## Benefits

✅ **No Hardcoding**: Colors extracted dynamically from themes  
✅ **Visual Consistency**: PondPilot matches Expressive Code exactly  
✅ **Easy Maintenance**: Change theme once, everything updates  
✅ **Type Safety**: Generated TypeScript prevents typos  
✅ **Performance**: Colors computed at build time, not runtime  
✅ **Future-Proof**: Works with any Shiki theme  
✅ **Upgrade-Safe**: Custom styles in separate file, won't conflict with theme updates  

## Credits

- **PondPilot Widget**: Interactive SQL execution powered by DuckDB WASM
- **Shiki**: Syntax highlighting engine
- **Expressive Code**: Astro integration for code blocks
- **OKLCH Color Space**: Perceptually uniform color manipulation

---

*Last Updated: November 5, 2025*
